<script>
    /**
     * The Mixin for a form.
     * Contains properties and methods associated with a form.
     *
     * @polymerMixin
     */
    UvalibForm = Polymer.dedupingMixin(function(superClass) {
        return class extends superClass {
            constructor() {
                super();
            }
            static get properties() {
                return {
                    /**
                     * User name, email address, department, etc. for use in pre-populating some information.
                     */
                    userInfo: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {
                                computing_id: '',
                                name: '',
                                email: '',
                                phone: '',
                                affiliation: '',
                                department_school: ''
                            };
                        }
                    },
                    _refresh: {
                        type: Boolean,
                        value: false
                    }
                };
            }

            static get observers() {
                return [
                    '_setRequestor(userInfo,_elements)'
                ]
            }

            ready() {
                this.addEventListener('changedValue', this._valueChanged);
                this.addEventListener('clickedButton', this._buttonClicked);
                super.ready();
            }

            _setRequestor(userInfo, _elements) {
                // @TODO needs review as we need to find field within the section that matches up...
                console.log('setRequestor');
                console.log(userInfo);
                for (var key in _elements) {
                    if (key.match(/^sect\_|fld\_|mkup\_|btn\_/)) {
                        // prefill user form field values if authenticated form
                        if (userInfo) {
                            if (key.match(/^fld_uva_computing_id/)) {
                                console.log('computing id');
                                _elements[key].value = userInfo.computing_id;
                                this.$.fld_uva_computing_id.value = userInfo.computing_id;
                                this.shadowRoot.querySelector('#fld_uva_computing_id').value = userInfo.computing_id;
                            } else if (key.match(/^fld_name/)) {
                                _elements[key].value = userInfo.name;
                            } else if (key.match(/^fld_email_address/)) {
                                _elements[key].value = userInfo.email;
                            } else if (key.match(/^fld_phone_number/)) {
                                _elements[key].value = userInfo.phone;
                            } else if (key.match(/^fld_university_affiliation/)) {
                                _elements[key].value = userInfo.affiliation;
                            } else if (key.match(/^fld_university_department_or_school/)) {
                                _elements[key].value = userInfo.department_school;
                            }
                        }
                    }
                }
            }

            _valueChanged(e) {
                //console.log(e.detail.field_id);
                this._refresh = !this._refresh;
            }

            // Loop through the section object key values and just examine the ones with
            // fld, mkup, fldset, ???
            _getSectionFields(el) {
                let fields = Array();
                for (var key in el) {
                    if (key.match(/^fld\_|fldset\_|mkup\_|actions/)) {
                        fields.push(el[key]);
                        if (el[key].type && el[key].type == 'textfield') {
                            el[key].type = 'text';
                        }
                    }
                }
                //console.log(fields);
                return fields;
            }

            _isButton(el) {
                return (el.type && el.type == "webform_actions");
            }

            _isCheckbox(el) {
                return (el.type && el.type == "checkbox");
            }

            _isField(el) {
                return (el.type && (el.type == "email" || el.type == "tel" || el.type == "text" || el.type == "select" || el.type == "textarea" || el.type == "radios" || el.type == "checkbox" || el.type == "fieldset" || el.type == "webform_actions"));
            }

            _isFieldset(el) {
                return (el.type && el.type == "fieldset");
            }

            _isInput(el) {
                return (el.type && (el.type == "email" || el.type == "tel" || el.type == "text"));
            }

            _isMarkup(el) {
                return (el.type && el.type == "webform_markup");
            }

            _isRadios(el) {
                return (el.type && el.type == "radios");
            }

            _isSelect(el) {
                return (el.type && el.type == "select");
            }

            _isSection(el) {
                return (el.type && el.type == "webform_section");
            }

            _isTextarea(el) {
                return (el.type && el.type == "textarea");
            }

            _showField(item, refresh) {
                //console.log('_showField');
                if (!item.states) return true;
                else if (item.states && item.states.visible) {
                    return this._testState(item.states.visible);
                } else if (item.states && item.states.required) {
                    return this._testState(item.states.required);
                }
            }

            _testState(state) {
                //console.log("state test:");
                //console.log(state);
                if (Array.isArray(state)) {
                    for (var i = 0; i < state.length; i = i + 2) {
                        if (this._testField(state[i])) return true;
                    }
                    return false;
                } else {
                    return this._testField(state);
                }
            }

            _testField(state) {
                //console.log('field test:');
                var test = true;
                // very error prone test - assuming much
                for (var key in state) {
                    var id = key.replace(/.*"(.*)".*/, "$1"),
                        val = state[key].value;
                    if (!this.shadowRoot.querySelector('#' + id) || this.shadowRoot.querySelector('#' + id).value != val) {
                        test = false;
                        break;
                    }
                }
                return test;
            }

        }
    });
</script>
