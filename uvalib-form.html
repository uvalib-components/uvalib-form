<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../uvalib-account/uvalib-account-auth.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="uvalib-form">
  <template>
    <style>
      :host {
        display: block;
      }
      .text-block {

      }
      .section {
        padding-top: 1rem;
      }
      fieldset {
        padding: 10px 0px;
        border: none;
      }
      legend {
        padding: 0px;
        font: 1.5rem bold serif;
      }
      .form-field {
        padding: 10px 0px 10px 0px;
      }
      label {
        display: block;
        font-weight: bold;
        padding-bottom: 5px;
      }
      .required {
        padding-left: 5px;
        color: var(--uvalib-main-rotunda-orange);
      }
      paper-button {
        border: 1px solid black;
      }
    </style>

    <uva-library path="web/forms" items="{{formDefinition}}" filter="{{_formFilter}}"></uva-library>

    <template is="dom-if" if="{{_authenticatedForm}}"><uvalib-account-auth user="{{userInfo}}"></uvalib-account-auth></template>
    <form method="post" action="{{_confirmationPagePath}}">
      <input type="hidden" name="[[formId]]" />
      <template is="dom-repeat" items="{{_formElements}}" as="elem">
        <template is="dom-if" if="{{_isFieldset(elem)}}">
          <template is="dom-if" if="{{_inFieldset}}">
            </fieldset>
          </div>
          </template>
          <div class="section">
            <fieldset>
              <legend>{{elem.title}}</legend>
                <template is="dom-repeat" items="{{_getFieldSetElements(elem)}}" as="fldset_elem">
                  <!--  REPLICATE other dom-if templates here?? Seems redundant. Rethink this... -->
                  <div>
                    <label>{{fldset_elem.title}}</label>
                  </div>
                </template>
        </template>
        <template is="dom-if" if="{{_isMarkup(elem)}}">
          <div class="text-block" inner-h-t-m-l="{{elem.markup}}"></div>
        </template>
        <template is="dom-if" if="{{_isSelect(elem)}}">
          <div class="form-field">
            <label for="{{elem.name}}">{{elem.title}}<template is="dom-if" if="{{_isRequired(elem)}}"><span class="required">*</span></template></label>
            <select id="{{elem.name}}" required="{{_isRequired(elem)}}">
              <template is="dom-repeat" items="{{_getArray(elem.options)}}" as="option">
                <template is="dom-if" if="{{_isValidOption(option)}}">
                  <option value="{{option}}">{{option}}</option>
                </template>
              </template>
            </select>
          </div>
        </template>
        <template is="dom-if" if="{{_isEmail(elem)}}">
          <div class="form-field">
            <label for="{{elem.name}}">{{elem.title}}<template is="dom-if" if="{{_isRequired(elem)}}"><span class="required">*</span></template></label>
            <input type="email" id="{{elem.name}}" required="{{_isRequired(elem)}}" error-message="{{elem.required_error}}"></input>
          </div>
        </template>
        <template is="dom-if" if="{{_isText(elem)}}">
          <div class="form-field">
            <label for="{{elem.name}}">{{elem.title}}<template is="dom-if" if="{{_isRequired(elem)}}"><span class="required">*</span></template></label>
            <input type="text" id="{{elem.name}}" required="{{_isRequired(elem)}}" error-message="{{elem.required_error}}"></input>
          </div>
        </template>
        <template is="dom-if" if="{{_isTextArea(elem)}}">
          <div class="form-field">
            <label for="{{elem.name}}">{{elem.title}}<template is="dom-if" if="{{_isRequired(elem)}}"><span class="required">*</span></template></label>
            <textarea id="{{elem.name}}" required="{{_isRequired(elem)}}" error-message="{{elem.required_error}}"></textarea>
          </div>
        </template>
        <template is="dom-if" if="{{_isSubmit(elem)}}">
          <paper-button>{{elem.submit.value}}</paper-button>
        </template>
      </template>
      <template is="dom-if" if="{{_noSubmitButton}}">
        <paper-button>Submit</paper-button>
      </template>
    </form>

  </template>

  <script>
    /**
     * `uvalib-form`
     * Component that builds out a web form UI using a form definition via the API.
     *
     * @TODO Need to utilize the states property to address showing/hiding elements as needed.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibForm extends Polymer.Element {
      static get is() { return 'uvalib-form'; }
      static get properties() {
        return {
          /**
           * User name, email address, department, etc. for use in pre-populating some information.
           */
          userInfo: {
            type: Object,
            value: function() { return {name: "Jack Kelly", emailAddress: "jkelly@virginia.edu", phone: "434-924-7119", affiliation: "Staff", departmentOrSchool: "UVA Library"}; }
          },
          /**
           * Used to indicate which workflow the server should use when processing the request submitted.
           */
          formId: {
            type: String
          },
          /**
           * An array containing the form page definition returned for the specified form id.
           */
          formDefinition: {
            type: Array,
            notify: true
          },
          /**
           * Filter for the uva library api call to select only the form id requested.
           */
          _formFilter: {
            type: Object,
            computed: '_filter(formId)'
          },
          /**
           * The object instance of the formDefinition string.
           */
          _formElements: {
            type: Array,
            computed: '_parseDefinition(formDefinition)'
          },
          _authenticatedForm: {
            type: Boolean,
            computed: '_isFormAuthenticated(_formElements)'
          },
          _confirmationPagePath: {
            type: String,
            computed: '_getConfirmationPagePath(_formElements)'
          },
          _inFieldset: {
            type: Boolean,
            value: false
          },
          _noSubmitButton: {
            type: Boolean,
            value: true
          }
        };
      }

      /**
       * Filter API web forms to get the one needed.
       * @return Object
       */
      _filter(id) {
        return {'target_id': id};
      }

      /**
       * Check authenticated field value to determine if form requires NetBadge.
       * @return Boolean
       */
      _isFormAuthenticated(frmElements) {
        let auth = _.find(frmElements, {title: 'authenticated'});
        return (auth.value == "yes") ? true : false;
      }

      _isRequired(elem) {
        return elem.required || (elem.required_error && (elem.required_error != ""));
      }
      _isMarkup(el) {
        return (el.type && el.type == "webform_markup") ? true : false;
      }
      _isSelect(el) {
        return (el.type && el.type=="select") ? true : false;
      }
      _isEmail(el) {
        return (el.type && el.type=="email") ? true : false;
      }
      _isPhone(el) {
        return (el.type && el.type=="tel") ? true : false;
      }
      _isText(el) {
        return (el.type && el.type=="textfield") ? true : false;
      }
      _isTextArea(el) {
        return (el.type && el.type=="textarea") ? true : false;
      }
      _isSubmit(el) {
        if (el.type && el.type=="webform_actions") {
          this._noSubmitButton = false;
          return true;
        } else {
          return false;
        }
      }
      _isFieldset(el) {
        this._inFieldset = true;
        return (el.type && el.type=="fieldset") ? true : false;
      }
      _isValidOption(value) {
        return (value != '- Select -') ? true : false;
      }
      _getFieldSetElements(el) {
        // Loop through the fieldset object key values and just examine the ones with
        // fld, mkup, fldset, ???
        let fields = _.values(el); 
        /*        _.filter(el, function (o, prop) {
          return /^(fld\_|mkup\_|fldset\_)/.test(prop.index);
        });*/
        console.log(fields);
        return fields;
      }

      _getArray(obj) {
        console.log(_.values(obj));
        return _.values(obj);
      }
      /**
       * Get the path for the confirmation page.
       * @return String
       */
      _getConfirmationPagePath(frmElements) {
        let path = _.find(frmElements, {title: 'confirmation page path'});
        return path.value;
      }

      /**
       * Returns web form definition for the form page object.
       * @return Array
       */
      _parseDefinition(frmDefn) {
        let fields = _.values(JSON.parse(frmDefn[0].webform));
        //let fields = _.map(JSON.parse(frmDefn[0].webform), function(value, key) { return { [key]: value }; });
        console.log(fields);
        return fields;
      }
    }

    window.customElements.define(UvalibForm.is, UvalibForm);
  </script>
</dom-module>
