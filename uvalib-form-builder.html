<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../uvalib-account/uvalib-account-user.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="uvalib-form.html">
<link rel="import" href="uvalib-form-style.html">
<link rel="import" href="uvalib-form-fieldset.html">
<link rel="import" href="uvalib-field-select.html">
<link rel="import" href="uvalib-field-input.html">
<link rel="import" href="uvalib-field-textarea.html">
<link rel="import" href="uvalib-field-checkbox.html">
<link rel="import" href="uvalib-field-button.html">
<link rel="import" href="uvalib-field-radios.html">

<dom-module id="uvalib-form-builder">
  <template>
    <custom-style>
      <style include="uvalib-theme uvalib-form-style">
      </style>
    </custom-style>

    <uva-library path="web/forms" items="{{formPage}}" filter="{{_formFilter}}"></uva-library>

    <uvalib-account-user id="user" auto="[[_authenticated]]" contact-info="{{userInfo}}"></uvalib-account-user>

    <form method="post">
      <input type="hidden" name="authenticated" value="[[_authenticated]]" />

      <div id="error-list" hidden$="[[!_invalidValues]]">
        <h2>Submission Errors Found</h2>
        <!--  insert error messages here after submit validation -->
        <!-- make sure to set aria-live="assertive" when providing error feedback -->
      </div>

      <template is="dom-repeat" items="{{_elements}}" as="elem">
        <template is="dom-if" if="[[_isSection(elem)]]">
          <div class="section" hidden$="{{!_showField(elem,_refresh)}}">
            <h2>[[elem.title]]</h2>
              <template is="dom-repeat" items="{{_getSectionFields(elem,userInfo)}}" as="fs_elem">
                <template is="dom-if" if="[[_isMarkup(fs_elem)]]">
                  <uvalib-field-html-markup id="[[fs_elem.webform_key]]" element="{{fs_elem}}" hidden$="{{!_showField(fs_elem,_refresh)}}" aria-invalid="{{!fs_elem.valid}}"></uvalib-field-html-markup>
                </template>
                <template is="dom-if" if="[[_isField(fs_elem)]]">
                  <template is="dom-if" if="[[_isFieldset(fs_elem)]]">
                    <uvalib-form-fieldset id="[[fs_elem.webform_key]]" element="{{fs_elem}}" aria-invalid="{{!fs_elem.valid}}"></uvalib-form-fieldset>
                  </template>
                  <template is="dom-if" if="[[_isSelect(fs_elem)]]">
                    <uvalib-field-select id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}" aria-invalid="{{!fs_elem.valid}}"></uvalib-field-select>
                  </template>
                  <template is="dom-if" if="[[_isInput(fs_elem)]]">
                    <uvalib-field-input id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}" aria-invalid="{{!fs_elem.valid}}"></uvalib-field-input>
                  </template>
                  <template is="dom-if" if="[[_isCheckbox(fs_elem)]]">
                    <uvalib-field-checkbox id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}" aria-invalid="{{!fs_elem.valid}}"></uvalib-field-checkbox>
                  </template>
                  <template is="dom-if" if="[[_isTextarea(fs_elem)]]">
                    <uvalib-field-textarea id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}" aria-invalid="{{!fs_elem.valid}}"></uvalib-field-textarea>
                  </template>
                  <template is="dom-if" if="[[_isButton(fs_elem)]]">
                    <uvalib-field-button id="[[fs_elem.webform_key]]" element="{{fs_elem}}" hidden$="{{!_showField(fs_elem,_refresh)}}"></uvalib-field-button>
                  </template>
                </template>
    </template>
    </div>
    </template>
    <template is="dom-if" if="[[_isMarkup(elem)]]">
          <uvalib-field-html-markup id="[[elem.webform_key]]" element="{{elem}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-html-markup>
        </template>
        <template is="dom-if" if="[[_isField(elem)]]">
          <template is="dom-if" if="[[_isSelect(elem)]]">
            <uvalib-field-select id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-select>
          </template>
          <template is="dom-if" if="[[_isInput(elem)]]">
            <uvalib-field-input id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-input>
          </template>
          <template is="dom-if" if="[[_isCheckbox(elem)]]">
            <uvalib-field-checkbox id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-checkbox>
          </template>
          <template is="dom-if" if="[[_isTextarea(elem)]]">
            <uvalib-field-textarea id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-textarea>
          </template>
          <template is="dom-if" if="[[_isButton(elem)]]">
            <uvalib-field-button id="[[elem.webform_key]]" element="{{elem}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-button>
          </template>
    </template>
    </template>
    </form>

  </template>

    <script>
        /**
         * `uvalib-form-builder`
         * Component that builds out a web form UI using a form definition via the API.
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         * @demo demo/purchase-request.html
         * @demo demo/uvalib-field-checkbox.html
         * @demo demo/uvalib-field-input.html
         * @demo demo/uvalib-field-select.html
         * @demo demo/uvalib-field-textarea.html
         * @demo demo/uvalib-form-fieldset.html
         */
        class UvalibFormBuilder extends UvalibForm(Polymer.Element) {
            static get is() {
                return 'uvalib-form-builder';
            }
            static get properties() {
                return Object.assign(super.properties, {
                    /**
                     * Used to indicate which workflow the server should use when processing the request submitted.
                     */
                    formId: {
                        type: String
                    },
                    /**
                     * An array containing the form page returned for the specified form id.
                     */
                    formPage: {
                        type: Array,
                        notify: true
                    },
                    /**
                     * Filter for the uva library api call to select only the form id requested.
                     */
                    _formFilter: {
                        type: Object,
                        computed: '_filter(formId)'
                    },
                    /**
                     * The form elements.
                     */
                    _elements: {
                        type: Array,
                        notify: true,
                        reflectToAttribute: true,
                        computed: '_parsePageForm(formPage)'
                    },
                    /**
                     * Authenticated form indicator.
                     */
                    _authenticated: {
                        type: Boolean,
                        computed: '_isFormAuthenticated(_elements)'
                    },
                    /**
                     * Form confirmation page path.
                     */
                    _confirmationPagePath: {
                        type: String,
                        computed: '_getConfirmationPagePath(_elements)'
                    },
                    _noSubmitButton: {
                        type: Boolean,
                        value: true
                    },
                    _invalidValues: {
                      type: Boolean,
                      value: false,
                      reflectToAttribute: true,
                    }
                });
            }

            _validateSection(fldIndex) {
              let err = false;
              console.log('section');
              console.log(fieldIndex+': '+key);
              for (var key in this._elements[fldIndex]) {
                if (key.match(/^fld_/)) {
                  // make sure required field doesn't have empty value
                  if (this._elements[fldIndex][key].required && this._elements[fldIndex][key].value == "") {
                    this._elements[fldIndex][key].valid = false;
                    err = (err || !this._elements[fldIndex][key].valid);
                  } else {
                    this._elements[fldIndex][key].valid = true;
                  }
                } else if (key.match(/^fldset_/)) {
                  // @TODO Revisit when we use <fieldset>
                }
              }
              return err;
            }

            _buttonClicked(e) {
              this._invalidValues = false;
              if (e.detail.name == 'Submit') {
                  // Loop through form fields to make sure required items have values
                  for (var i=0; i<this._elements.length; i++) {
                    let field = this._elements[i].webform_key;
                    if (field.match(/^sect_/)) {
                      this._invalidValues = (this._invalidValues || this._validateSection(i));
                    } else if (field.match(/^fld_/)) {
                      // make sure required field doesn't have empty value
                      if (this._elements[i].required && this._elements[i].value === "") {
                        this._elements[i].valid = false;
                        this._invalidValues = (this._invalidValues || !this._elements[i].valid);
                      } else {
                        this._elements[i].valid = true;
                      }
                    } else if (field.match(/^fldset_/)) {
                      // @TODO Revisit when we use <fieldset>
                    }
                  }
                  // if no errors then save the request.
                  if (!this._invalidValues) {
                    this.$.user.saveRequest(this._elements);
                  } else {
                    console.log('Required fields are missing.');
                  }
                  console.log(this._elements);
              }
            }

            /**
             * Filter API web forms to get the one needed.
             * @return Object
             */
            _filter(id) {
                return {
                    'target_id': id
                };
            }

            /**
             * Check authenticated field value to determine if form requires NetBadge.
             * @return Boolean
             */
            _isFormAuthenticated(els) {
                let auth = _.find(els, {
                    title: 'authenticated'
                });
                return (auth.value && auth.value == "yes") ? true : false;
            }

            /**
             * Get the path for the confirmation page.
             * @return String
             */
            _getConfirmationPagePath(els) {
                let path = _.find(els, {
                    title: 'confirmation page path'
                });
                return path.value;
            }

            /**
             * Returns web form definition for the form page object.
             * @return Array
             */
            _parsePageForm(frmPg) {
                var fields = Array();
                if (frmPg) {
                    var form = JSON.parse(frmPg[0].webform);
                    for (var key in form) {
                        if (key.match(/^sect_/)) {
                          for (var skey in form[key]) {
                            if (skey.match(/^fld_|fldset_/)) {
                              form[key][skey].valid = true;
                              if (form[key][skey].type && form[key][skey].type == 'textfield') {
                                form[key][skey].type = 'text';
                              }
                            }
                          }
                        }
                        if (key.match(/^sect\_|fld\_|fldset\_|mkup\_|btn\_|authenticated|confirmation/)) {
                            fields.push(form[key]);
                            form[key].valid = true;
                            if (form[key].type && form[key].type == 'textfield') {
                                form[key].type = 'text';
                            }
                        }
                    }
                }
                console.log(fields);
                return fields;
            }

        }

        window.customElements.define(UvalibFormBuilder.is, UvalibFormBuilder);
    </script>
</dom-module>
