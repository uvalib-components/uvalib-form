<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../uvalib-account/uvalib-account-auth.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="uvalib-form.html">
<link rel="import" href="uvalib-form-style.html">
<link rel="import" href="uvalib-form-fieldset.html">
<link rel="import" href="uvalib-field-select.html">
<link rel="import" href="uvalib-field-input.html">
<link rel="import" href="uvalib-field-textarea.html">
<link rel="import" href="uvalib-field-checkbox.html">
<!-- link rel="import" href="uvalib-field-button.html" -->

<dom-module id="uvalib-form-builder">
  <template>
    <custom-style>
      <style include="uvalib-theme uvalib-form-style">
      </style>
    </custom-style>

    <uva-library path="web/forms" items="{{formPage}}" filter="{{_formFilter}}"></uva-library>

    <template is="dom-if" if="[[_authenticated]]"><uvalib-account-auth user="{{userInfo}}"></uvalib-account-auth></template>
    <form method="post">
      <input type="hidden" name="[[formId]]" />
      <template is="dom-repeat" items="{{_elements}}" as="elem">
        <template is="dom-if" if="[[_isFieldset(elem)]]">
          <div class="section" hidden$="{{!_showField(elem,_refresh)}}">
            <fieldset>
              <legend tabindex="0" aria-label$="[[ele.title]] section">[[elem.title]]</legend>
                <template is="dom-repeat" items="{{_getFieldSetElements(elem)}}" as="fs_elem">
                  <template is="dom-if" if="[[_isMarkup(fs_elem)]]">
                    <uvalib-field-html-markup id="[[fs_elem.webform_key]]" element="{{fs_elem}}" hidden$="{{!_showField(fs_elem,_refresh)}}"></uvalib-field-html-markup>
                  </template>
                  <template is="dom-if" if="[[_isField(fs_elem)]]">
                    <template is="dom-if" if="[[_isSelect(fs_elem)]]">
                      <uvalib-field-select id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}"></uvalib-field-select>
                    </template>
                    <template is="dom-if" if="[[_isInput(fs_elem)]]">
                      <uvalib-field-input id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}"></uvalib-field-input>
                    </template>
                    <template is="dom-if" if="[[_isCheckbox(fs_elem)]]">
                      <uvalib-field-checkbox id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}"></uvalib-field-checkbox>
                    </template>
                    <template is="dom-if" if="[[_isTextarea(fs_elem)]]">
                      <uvalib-field-textarea id="[[fs_elem.webform_key]]" element="{{fs_elem}}" value="{{fs_elem.value}}" hidden$="{{!_showField(fs_elem,_refresh)}}"></uvalib-field-textarea>
                    </template>
                  </template>
                </template>
            </fieldset>
          </div>
        </template>
        <template is="dom-if" if="[[_isMarkup(elem)]]">
          <uvalib-field-html-markup id="[[elem.webform_key]]" element="{{elem}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-html-markup>
        </template>
        <template is="dom-if" if="[[_isField(elem)]]">
          <template is="dom-if" if="[[_isSelect(elem)]]">
            <uvalib-field-select id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-select>
          </template>
          <template is="dom-if" if="[[_isInput(elem)]]">
            <uvalib-field-input id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-input>
          </template>
          <template is="dom-if" if="[[_isCheckbox(elem)]]">
            <uvalib-field-checkbox id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-checkbox>
          </template>
          <template is="dom-if" if="[[_isTextarea(elem)]]">
            <uvalib-field-textarea id="[[elem.webform_key]]" element="{{elem}}" value="{{elem.value}}" hidden$="{{!_showField(elem,_refresh)}}"></uvalib-field-textarea>
          </template>
        </template>
      </template>
      <template is="dom-if" if="{{_noSubmitButton}}">
        <input type="submit" value="Submit"/>
      </template>
    </form>

  </template>

  <script>
    /**
     * `uvalib-form-builder`
     * Component that builds out a web form UI using a form definition via the API.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     * @demo demo/purchase-request.html
     * @demo demo/uvalib-field-checkbox.html
     * @demo demo/uvalib-field-input.html
     * @demo demo/uvalib-field-select.html
     * @demo demo/uvalib-field-textarea.html
     * @demo demo/uvalib-form-fieldset.html
     */
    class UvalibFormBuilder extends UvalibForm(Polymer.Element) {
      static get is() { return 'uvalib-form-builder'; }
      static get properties() {
        return Object.assign(super.properties,{
          /**
           * Used to indicate which workflow the server should use when processing the request submitted.
           */
          formId: {
            type: String
          },
          /**
           * An array containing the form page returned for the specified form id.
           */
          formPage: {
            type: Array,
            notify: true
          },
          /**
           * Filter for the uva library api call to select only the form id requested.
           */
          _formFilter: {
            type: Object,
            computed: '_filter(formId)'
          },
          /**
           * The form elements.
           */
          _elements: {
            type: Array,
            computed: '_parsePageForm(formPage)'
          },
          /**
           * Authenticated form indicator.
           */
          _authenticated: {
            type: Boolean,
            computed: '_isFormAuthenticated(_elements)'
          },
          /**
           * Form confirmation page path.
           */
          _confirmationPagePath: {
            type: String,
            computed: '_getConfirmationPagePath(_elements)'
          },
          _noSubmitButton: {
            type: Boolean,
            value: true
          }
        });
      }

      _showSubmit(item){
        var isSubmit = item.type && item.type === "webform_actions";
        if (!isSubmit) return false;
        else if (!item.states) return true;
        else if (item.states && item.states.visible) {
          return this._testState(item.states.visible);
        }
      }

      /**
       * Filter API web forms to get the one needed.
       * @return Object
       */
      _filter(id) {
        return {'target_id': id};
      }

      /**
       * Check authenticated field value to determine if form requires NetBadge.
       * @return Boolean
       */
      _isFormAuthenticated(els) {
        let auth = _.find(els, {title: 'authenticated'});
        return (auth.value == "yes") ? true : false;
      }

      _isSubmit(el) {
        if (el.type && el.type=="webform_actions") {
          this._noSubmitButton = false;
          return true;
        } else {
          return false;
        }
      }

      /**
       * Get the path for the confirmation page.
       * @return String
       */
      _getConfirmationPagePath(els) {
        let path = _.find(els, {title: 'confirmation page path'});
        return path.value;
      }

      /**
       * Returns web form definition for the form page object.
       * @return Array
       */
      _parsePageForm(frmPg) {
        var fields = Array();
        if (frmPg) {
          var form = JSON.parse(frmPg[0].webform);
          for (var key in form) {
            if (key.match(/^fld\_|fldset\_|mkup\_|authenticated|confirmation|actions/)) {
              fields.push(form[key]);
              if (form[key].type && form[key].type == 'textfield') {
                form[key].type = 'text';
              }
            }
          }
        }
        console.log(fields);
        return fields;
      }
      // Loop through the fieldset object key values and just examine the ones with
      // fld, mkup, fldset, ???
      _getFieldSetElements(el) {
        let fields = Array();
        for (var key in el) {
          if (key.match(/^fld\_|mkup\_|actions/)) {
            fields.push(el[key]);
            if (el[key].type && el[key].type == 'textfield') {
              el[key].type = 'text';
            }
          }
        }
        //console.log(fields);
        return fields;
      }

    }

    window.customElements.define(UvalibFormBuilder.is, UvalibFormBuilder);
  </script>
</dom-module>
